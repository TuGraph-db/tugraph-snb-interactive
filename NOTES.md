# TuGraph SNB Implementation Notes

This document contains a brief summary of how TuGraph implements the Interactive workload of SNB.

## Data Types

Data types used in SNB are implemented with the following mappings:
- ID: `INT64`
- 32-bit integer: `INT32`
- 64-bit integer: `INT64`
- String, Long String, Text: `STRING`
- Date, DateTime: `INT64`
    - [Date](https://github.com/HowardHinnant/date/) is used for Date/DateTime arithmetics
- List of Strings: `STRING`
    - Items are separated via ';'

## Data Schema

The schema can be inferred from `import.conf`.
Some traits:
- 1-to-1 and 1-to-N relationships are inlined as vertex properties (like foreign keys).
- Some relationships are further refined according to the connecting entity types:
    - `hasTag`: `forumHasTag`, `postHasTag`, `commenthasTag`
    - `hasCreator`: `postHasCreator`, `commentHasCreator`
    - `isLocatedIn`: `personIsLocatedIn`, `postIsLocatedIn`, `commentIsLocatedIn`
- There are two precomputed edge properties (similar to materialized views):
    - `hasMember.numPosts` which maintains the number of posts the given person posted in the given forum (used in Complex Read 5)
    - `knows.weight` which maintains the weight between the pair of given persons, calculated using the formula in Complex Read 14

### Indexes

Unique indexes are defined on:
- `id` fields of all vertices (built automatically during data import)
- `name` fields of `TagClass` and `Tag`

A non-unique index is defined on `Place.name`.

## Data Generation

In addition to using the `CsvCompositeMergeForeign` classes for serialization, TuGraph uses `LongDateFormatter` for Date/DateTime, and specifies `numUpdatePartitions` to generate multiple update streams.

## Bulk Load

The bulk load phase consists of three steps:
- Data preparation: a text processing script converts the csv files generated by `datagen` to a form that the TuGraph import utility requires.
- Importing: `lgraph_import` is used to import the initial dataset. `id` indexes are built during this period.
- Preprocessing: `preprocess` is executed which performs the following actions:
    - Converting foreign key fields to actual vertex identifiers
    - Building those `name` indexes
    - Materializing `hasMember.numPosts` and `knows.weight`

## Stored Procedures

All the operations are implemented with stored procedures using TuGraph Core API.
Read (both complex and short) operations are marked as Read-Only while update operations are marked as Read-Write.

Besides the insertions defined in the specification document, Update {5, 6} and Update {7, 8} contain additional logics for maintenance of the two precomputed edge properties.
`check_consistency` can be used for checking the consistency of materialization.

## ACID Tests

`acid` contains test cases detecting different types of anomalies.
Using optimistic mode of read-write transactions is able to pass all but Write Skew tests (the first run).
Using pessimistic mode of read-write transactions is able to pass all tests (the second run).

Write skews can be avoided in optimistic mode by generating write-write conflicts explicitly (i.e. adding the read set for validation as well). Some read-write stored procedures use this technique to ensure consistency.
